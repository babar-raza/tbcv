{% extends "base.html" %}

{% block title %}Performance Monitoring - TBCV Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/monitoring.css">
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-left">
            <h1>Performance Monitoring Dashboard</h1>
            <p class="subtitle">Real-time system metrics and performance analytics</p>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <span class="status-dot" id="connection-status"></span>
                <span id="connection-text">Connecting...</span>
            </div>
            <div class="last-update">
                Last Update: <span id="last-update-time">--:--:--</span>
            </div>
            <div class="auto-refresh">
                <label>
                    <input type="checkbox" id="auto-refresh" checked>
                    Auto-Refresh
                </label>
            </div>
        </div>
    </div>

    <!-- Alert Banner -->
    <div id="alert-banner" class="alert-banner" style="display: none;">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <span id="alert-message"></span>
        <button class="alert-close" onclick="closeAlert()">√ó</button>
    </div>

    <!-- Quick Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-icon">üìä</div>
            <div class="stat-value" id="validation-throughput">--</div>
            <div class="stat-label">Validations/min</div>
            <div class="stat-trend" id="validation-trend"></div>
        </div>

        <div class="stat-card success">
            <div class="stat-icon">üéØ</div>
            <div class="stat-value" id="agent-performance">--</div>
            <div class="stat-label">Agent Avg (ms)</div>
            <div class="stat-trend" id="agent-trend"></div>
        </div>

        <div class="stat-card info">
            <div class="stat-icon">üíæ</div>
            <div class="stat-value" id="cache-hit-rate">--</div>
            <div class="stat-label">Cache Hit Rate</div>
            <div class="stat-trend" id="cache-trend"></div>
        </div>

        <div class="stat-card warning">
            <div class="stat-icon">‚ö°</div>
            <div class="stat-value" id="db-query-time">--</div>
            <div class="stat-label">DB Avg (ms)</div>
            <div class="stat-trend" id="db-trend"></div>
        </div>
    </div>

    <!-- Time Range Selector -->
    <div class="controls-bar">
        <div class="time-range-selector">
            <label>Time Range:</label>
            <button class="range-btn active" data-range="1h">1 Hour</button>
            <button class="range-btn" data-range="6h">6 Hours</button>
            <button class="range-btn" data-range="24h">24 Hours</button>
            <button class="range-btn" data-range="7d">7 Days</button>
        </div>

        <div class="export-controls">
            <button class="btn-export" onclick="exportData('csv')">
                <span class="icon">üì•</span> Export CSV
            </button>
            <button class="btn-export" onclick="exportData('json')">
                <span class="icon">üì•</span> Export JSON
            </button>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Throughput Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>Validation Throughput</h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="refreshChart('throughput')">üîÑ</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="throughput-chart"></canvas>
            </div>
        </div>

        <!-- Response Time Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>Response Times</h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="refreshChart('response-time')">üîÑ</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="response-time-chart"></canvas>
            </div>
        </div>

        <!-- System Resources Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>System Resources</h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="refreshChart('system-resources')">üîÑ</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="system-resources-chart"></canvas>
            </div>
        </div>

        <!-- Error Rate Chart -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>Error Rate & Success</h3>
                <div class="chart-controls">
                    <button class="chart-btn" onclick="refreshChart('error-rate')">üîÑ</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="error-rate-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Metrics Section -->
    <div class="metrics-section">
        <div class="section-header">
            <h2>Detailed Metrics</h2>
            <button class="btn-refresh" onclick="refreshAllMetrics()">
                <span class="icon">üîÑ</span> Refresh All
            </button>
        </div>

        <!-- Agent Performance Table -->
        <div class="metric-card">
            <h3>Agent Performance</h3>
            <div class="table-responsive">
                <table class="metrics-table">
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>Count</th>
                            <th>Avg (ms)</th>
                            <th>Min (ms)</th>
                            <th>Max (ms)</th>
                            <th>P95 (ms)</th>
                            <th>P99 (ms)</th>
                            <th>Success Rate</th>
                        </tr>
                    </thead>
                    <tbody id="agent-metrics-body">
                        <tr>
                            <td colspan="8" class="loading">Loading metrics...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Database Performance Table -->
        <div class="metric-card">
            <h3>Database Operations</h3>
            <div class="table-responsive">
                <table class="metrics-table">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>Count</th>
                            <th>Avg (ms)</th>
                            <th>Min (ms)</th>
                            <th>Max (ms)</th>
                            <th>P95 (ms)</th>
                            <th>P99 (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="db-metrics-body">
                        <tr>
                            <td colspan="7" class="loading">Loading metrics...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cache Performance -->
        <div class="metric-card">
            <h3>Cache Performance</h3>
            <div class="cache-stats-grid">
                <div class="cache-stat">
                    <div class="cache-label">Hit Rate</div>
                    <div class="cache-value" id="cache-hit-rate-detail">--</div>
                </div>
                <div class="cache-stat">
                    <div class="cache-label">Total Hits</div>
                    <div class="cache-value" id="cache-total-hits">--</div>
                </div>
                <div class="cache-stat">
                    <div class="cache-label">Total Misses</div>
                    <div class="cache-value" id="cache-total-misses">--</div>
                </div>
                <div class="cache-stat">
                    <div class="cache-label">Cache Size</div>
                    <div class="cache-value" id="cache-size">--</div>
                </div>
            </div>
        </div>

        <!-- System Resources -->
        <div class="metric-card">
            <h3>System Resources</h3>
            <div class="resource-grid">
                <div class="resource-item">
                    <div class="resource-header">
                        <span class="resource-label">CPU Usage</span>
                        <span class="resource-value" id="cpu-usage">--</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="cpu-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="resource-item">
                    <div class="resource-header">
                        <span class="resource-label">Memory Usage</span>
                        <span class="resource-value" id="memory-usage">--</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="memory-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="resource-item">
                    <div class="resource-header">
                        <span class="resource-label">Disk Usage</span>
                        <span class="resource-value" id="disk-usage">--</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="disk-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="resource-item">
                    <div class="resource-header">
                        <span class="resource-label">Active Connections</span>
                        <span class="resource-value" id="active-connections">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Configuration Section -->
    <div class="alert-config-section">
        <div class="section-header">
            <h2>Alert Thresholds</h2>
            <button class="btn-save" onclick="saveThresholds()">
                <span class="icon">üíæ</span> Save Configuration
            </button>
        </div>

        <div class="threshold-grid">
            <div class="threshold-item">
                <label>Validation Throughput (min/min)</label>
                <input type="number" id="threshold-throughput" value="100" min="0">
            </div>

            <div class="threshold-item">
                <label>Agent Response Time (ms)</label>
                <input type="number" id="threshold-agent-time" value="1000" min="0">
            </div>

            <div class="threshold-item">
                <label>DB Query Time (ms)</label>
                <input type="number" id="threshold-db-time" value="500" min="0">
            </div>

            <div class="threshold-item">
                <label>Cache Hit Rate (%)</label>
                <input type="number" id="threshold-cache-rate" value="70" min="0" max="100">
            </div>

            <div class="threshold-item">
                <label>CPU Usage (%)</label>
                <input type="number" id="threshold-cpu" value="80" min="0" max="100">
            </div>

            <div class="threshold-item">
                <label>Memory Usage (%)</label>
                <input type="number" id="threshold-memory" value="85" min="0" max="100">
            </div>

            <div class="threshold-item">
                <label>Error Rate (%)</label>
                <input type="number" id="threshold-error-rate" value="5" min="0" max="100">
            </div>

            <div class="threshold-item">
                <label>Alert Cooldown (minutes)</label>
                <input type="number" id="alert-cooldown" value="15" min="1">
            </div>
        </div>
    </div>

    <!-- Recent Alerts Log -->
    <div class="alerts-log-section">
        <div class="section-header">
            <h2>Recent Alerts</h2>
            <button class="btn-clear" onclick="clearAlerts()">
                <span class="icon">üóëÔ∏è</span> Clear All
            </button>
        </div>

        <div class="alerts-list" id="alerts-list">
            <div class="empty-state">
                <p>No recent alerts</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="/static/js/monitoring.js"></script>
{% endblock %}
