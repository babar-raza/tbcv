{% extends "base.html" %}

{% block title %}Validations - TBCV{% endblock %}

{% block content %}
<h1 style="margin-bottom: 30px;">Validations</h1>

<div class="filter-bar">
    <form method="GET" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <label for="status">Status:</label>
        <select name="status" id="status" onchange="this.form.submit()">
            <option value="">All</option>
            <option value="pass" {% if status_filter == 'pass' %}selected{% endif %}>Pass</option>
            <option value="fail" {% if status_filter == 'fail' %}selected{% endif %}>Fail</option>
            <option value="warning" {% if status_filter == 'warning' %}selected{% endif %}>Warning</option>
            <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
            <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
            <option value="enhanced" {% if status_filter == 'enhanced' %}selected{% endif %}>Enhanced</option>
        </select>
        
        <label for="severity">Severity:</label>
        <select name="severity" id="severity" onchange="this.form.submit()">
            <option value="">All</option>
            <option value="low" {% if severity_filter == 'low' %}selected{% endif %}>Low</option>
            <option value="medium" {% if severity_filter == 'medium' %}selected{% endif %}>Medium</option>
            <option value="high" {% if severity_filter == 'high' %}selected{% endif %}>High</option>
            <option value="critical" {% if severity_filter == 'critical' %}selected{% endif %}>Critical</option>
        </select>
        
        <button type="submit" class="btn btn-primary">Filter</button>
        
        <!-- Live refresh toggle -->
        <label style="margin-left: 20px;">
            <input type="checkbox" id="liveRefresh" checked> Live Refresh
        </label>
        
        <div style="margin-left: auto;">
            <button type="button" class="btn btn-success" onclick="openRunValidationModal()">‚ñ∂ Run Validation</button>
        </div>
    </form>
</div>

<!-- Active Validation Runs Section -->
<div id="activeValidationsSection" style="display: none;" class="card">
    <h2>Active Validation Runs</h2>
    <div id="activeValidationsList"></div>
</div>

<!-- Run Validation Modal -->
<div id="runValidationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-bottom: 20px;">Run Validation</h2>
        
        <form id="runValidationForm">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Validation Mode:</label>
                <select id="validationMode" class="form-control" onchange="updateValidationForm()" required>
                    <option value="">Select mode...</option>
                    <option value="single">Single File</option>
                    <option value="batch">Batch Files</option>
                </select>
            </div>
            
            <div id="singleValidationFields" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Select File:</label>
                    <input type="file" id="singleFile" class="form-control" accept=".md,.txt,.html,.json,.yaml,.yml">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">Supported: .md, .txt, .html, .json, .yaml, .yml</div>
                </div>
                
                <div id="fileInfo" style="display: none; margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                    <div style="font-size: 13px;"><strong>File:</strong> <span id="fileName"></span></div>
                    <div style="font-size: 13px;"><strong>Size:</strong> <span id="fileSize"></span></div>
                </div>
            </div>
            
            <div id="batchValidationFields" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Batch Mode:</label>
                    <select id="batchMode" class="form-control" onchange="updateBatchMode()">
                        <option value="upload">Upload Files (from your computer)</option>
                        <option value="server">Server Paths (files on server)</option>
                    </select>
                </div>

                <div id="batchUploadFields" style="display: block;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Select Files:</label>
                        <input type="file" id="batchFileInput" class="form-control" accept=".md,.txt,.html,.json,.yaml,.yml" multiple style="display: none;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('batchFileInput').click()" style="width: 100%; margin-bottom: 10px;">
                            Browse Files...
                        </button>

                        <div id="dropZone" style="border: 2px dashed #ddd; border-radius: 8px; padding: 40px 20px; text-align: center; background: #f9f9f9; cursor: pointer; transition: all 0.3s;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                            <div style="font-size: 16px; font-weight: 600; margin-bottom: 5px;">Drop files here</div>
                            <div style="font-size: 13px; color: #666;">or click "Browse Files" button above</div>
                            <div style="font-size: 12px; color: #999; margin-top: 10px;">Supported: .md, .txt, .html, .json, .yaml, .yml</div>
                        </div>

                        <div id="selectedFilesList" style="margin-top: 15px; display: none;">
                            <div style="font-weight: 600; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <span>Selected Files (<span id="selectedFilesCount">0</span>)</span>
                                <button type="button" class="btn btn-danger btn-sm" onclick="clearSelectedFiles()">Clear All</button>
                            </div>
                            <div id="filesListContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: white;">
                            </div>
                            <div style="margin-top: 10px; font-size: 13px; color: #666;">
                                <strong>Total Size:</strong> <span id="totalFileSize">0 B</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="batchServerFields" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">File Paths (one per line):</label>
                        <textarea id="batchFilePaths" class="form-control" rows="6" placeholder="/path/to/file1.md&#10;/path/to/file2.md"></textarea>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Enter full file paths from your server filesystem</div>
                    </div>
                </div>
            </div>
            
            <div id="validationCommonFields" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Family:</label>
                    <select id="validationFamily" class="form-control">
                        <option value="words">Words</option>
                        <option value="cells">Cells</option>
                        <option value="slides">Slides</option>
                        <option value="pdf">PDF</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Validation Types:</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <label><input type="checkbox" value="yaml" class="validation-type" checked> YAML</label>
                        <label><input type="checkbox" value="markdown" class="validation-type" checked> Markdown</label>
                        <label><input type="checkbox" value="code" class="validation-type" checked> Code</label>
                        <label><input type="checkbox" value="links" class="validation-type" checked> Links</label>
                        <label><input type="checkbox" value="structure" class="validation-type" checked> Structure</label>
                        <label><input type="checkbox" value="Truth" class="validation-type" checked> Truth</label>
                        <label><input type="checkbox" value="FuzzyLogic" class="validation-type" checked> FuzzyLogic</label>
                    </div>
                </div>
                
                <div id="maxWorkersField" style="margin-bottom: 15px; display: none;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Max Workers:</label>
                    <input type="number" id="validationMaxWorkers" class="form-control" value="4" min="1" max="16">
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                <button type="button" class="btn btn-secondary" onclick="closeRunValidationModal()">Cancel</button>
                <button type="submit" class="btn btn-success" id="submitValidationBtn">Start Validation</button>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Actions -->
<div class="bulk-actions" style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px;">
    <div style="display: flex; gap: 10px; align-items: center;">
        <label>
            <input type="checkbox" id="selectAll"> Select All
        </label>
        <button class="btn btn-success" onclick="bulkAction('approve')" disabled id="bulkApproveBtn">
            Bulk Approve
        </button>
        <button class="btn btn-danger" onclick="bulkAction('reject')" disabled id="bulkRejectBtn">
            Bulk Reject
        </button>
        <button class="btn btn-warning" onclick="bulkAction('enhance')" disabled id="bulkEnhanceBtn">
            Bulk Enhance
        </button>
        <span id="selectedCount" style="margin-left: 20px; font-weight: bold;">0 selected</span>
    </div>
</div>

<div class="card">
    {% if validations %}
    <table id="validationsTable">
        <thead>
            <tr>
                <th>Select</th>
                <th>File Path</th>
                <th>Status</th>
                <th>Severity</th>
                <th>Recommendations</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for validation in validations %}
            <tr data-validation-id="{{ validation.id }}">
                <td>
                    <input type="checkbox" class="validation-checkbox" value="{{ validation.id }}">
                </td>
                <td class="truncate">{{ validation.file_path }}</td>
                <td><span class="badge badge-{{ validation.status }}">{{ validation.status }}</span></td>
                <td><span class="badge badge-{{ validation.severity }}">{{ validation.severity }}</span></td>
                <td>{{ validation.recommendations_count }}</td>
                <td>{{ validation.created_at }}</td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        <a href="/dashboard/validations/{{ validation.id }}" class="btn btn-primary btn-sm">View</a>
                        {% if validation.status not in ['approved', 'rejected', 'enhanced'] %}
                        <button class="btn btn-success btn-sm" onclick="singleAction('approve', '{{ validation.id }}')">
                            Approve
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="singleAction('reject', '{{ validation.id }}')">
                            Reject
                        </button>
                        {% endif %}
                        <button class="btn btn-info btn-sm" onclick="generateRecommendations('{{ validation.id }}')">
                            Generate Recommendations
                        </button>
                        {% if validation.status == 'approved' %}
                        <button class="btn btn-warning btn-sm" onclick="singleAction('enhance', '{{ validation.id }}')">
                            Enhance
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if has_prev or has_next %}
    <div class="pagination">
        {% if has_prev %}
        <a href="?page={{ page - 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}" class="btn btn-secondary">‚Üê Previous</a>
        {% endif %}
        <span style="padding: 8px 16px;">Page {{ page }}</span>
        {% if has_next %}
        <a href="?page={{ page + 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}" class="btn btn-secondary">Next ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <p>No validations found</p>
    </div>
    {% endif %}
</div>

<!-- Status Messages -->
<div id="statusMessages" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

<script>
let activeValidationRuns = new Map();
let validationPollIntervals = new Map();
let selectedFile = null;
let selectedBatchFiles = [];

// Handle file selection
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('singleFile');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('fileInfo').style.display = 'block';
            } else {
                selectedFile = null;
                document.getElementById('fileInfo').style.display = 'none';
            }
        });
    }

    // Handle batch file input
    const batchFileInput = document.getElementById('batchFileInput');
    if (batchFileInput) {
        batchFileInput.addEventListener('change', function(e) {
            handleBatchFilesSelection(Array.from(e.target.files));
        });
    }

    // Setup drag and drop
    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        dropZone.addEventListener('click', function() {
            document.getElementById('batchFileInput').click();
        });

        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#667eea';
            this.style.background = '#f0f0ff';
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#ddd';
            this.style.background = '#f9f9f9';
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.borderColor = '#ddd';
            this.style.background = '#f9f9f9';

            const files = Array.from(e.dataTransfer.files);
            handleBatchFilesSelection(files);
        });
    }
});

function updateBatchMode() {
    const mode = document.getElementById('batchMode').value;
    document.getElementById('batchUploadFields').style.display = mode === 'upload' ? 'block' : 'none';
    document.getElementById('batchServerFields').style.display = mode === 'server' ? 'block' : 'none';
}

function handleBatchFilesSelection(files) {
    const validExtensions = ['.md', '.txt', '.html', '.json', '.yaml', '.yml'];

    files.forEach(file => {
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        if (validExtensions.includes(ext)) {
            // Check if file already exists
            const exists = selectedBatchFiles.some(f => f.name === file.name && f.size === file.size);
            if (!exists) {
                selectedBatchFiles.push(file);
            }
        } else {
            showValidationMessage(`Skipped ${file.name}: Unsupported file type`, 'warning');
        }
    });

    updateBatchFilesList();
}

function updateBatchFilesList() {
    const listContainer = document.getElementById('filesListContainer');
    const selectedFilesList = document.getElementById('selectedFilesList');
    const countSpan = document.getElementById('selectedFilesCount');
    const totalSizeSpan = document.getElementById('totalFileSize');

    if (selectedBatchFiles.length === 0) {
        selectedFilesList.style.display = 'none';
        return;
    }

    selectedFilesList.style.display = 'block';
    countSpan.textContent = selectedBatchFiles.length;

    let totalSize = selectedBatchFiles.reduce((sum, file) => sum + file.size, 0);
    totalSizeSpan.textContent = formatFileSize(totalSize);

    listContainer.innerHTML = '';
    selectedBatchFiles.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 13px;';

        fileItem.innerHTML = `
            <div style="flex: 1; overflow: hidden;">
                <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${file.name}</div>
                <div style="color: #666; font-size: 12px;">${formatFileSize(file.size)}</div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeBatchFile(${index})" style="margin-left: 10px;">Remove</button>
        `;

        listContainer.appendChild(fileItem);
    });
}

function removeBatchFile(index) {
    selectedBatchFiles.splice(index, 1);
    updateBatchFilesList();
}

function clearSelectedFiles() {
    selectedBatchFiles = [];
    updateBatchFilesList();
    document.getElementById('batchFileInput').value = '';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function openRunValidationModal() {
    document.getElementById('runValidationModal').style.display = 'flex';
}

function closeRunValidationModal() {
    document.getElementById('runValidationModal').style.display = 'none';
    document.getElementById('runValidationForm').reset();
    document.getElementById('singleValidationFields').style.display = 'none';
    document.getElementById('batchValidationFields').style.display = 'none';
    document.getElementById('validationCommonFields').style.display = 'none';
    document.getElementById('maxWorkersField').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'none';
    selectedFile = null;
    clearSelectedFiles();
}

function updateValidationForm() {
    const mode = document.getElementById('validationMode').value;
    document.getElementById('singleValidationFields').style.display = mode === 'single' ? 'block' : 'none';
    document.getElementById('batchValidationFields').style.display = mode === 'batch' ? 'block' : 'none';
    document.getElementById('validationCommonFields').style.display = mode ? 'block' : 'none';
    document.getElementById('maxWorkersField').style.display = mode === 'batch' ? 'block' : 'none';
}

document.getElementById('runValidationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitValidationBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Starting...';
    
    try {
        const mode = document.getElementById('validationMode').value;
        const validationTypes = Array.from(document.querySelectorAll('.validation-type:checked')).map(cb => cb.value);
        
        let endpoint, payload, runId;
        
        if (mode === 'single') {
            if (!selectedFile) {
                alert('Please select a file to validate');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Start Validation';
                return;
            }
            
            // Read file content
            const content = await readFileContent(selectedFile);
            
            endpoint = '/api/validate';
            payload = {
                content: content,
                file_path: selectedFile.name,
                family: document.getElementById('validationFamily').value,
                validation_types: validationTypes
            };
            runId = `single-${Date.now()}`;
        } else if (mode === 'batch') {
            endpoint = '/api/validate/batch';
            const batchMode = document.getElementById('batchMode').value;

            if (batchMode === 'upload') {
                // Handle client-side file upload
                if (selectedBatchFiles.length === 0) {
                    alert('Please select at least one file to upload');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Start Validation';
                    return;
                }

                // Read all files and create payload with file contents
                submitBtn.textContent = 'Reading files...';
                const fileContents = await Promise.all(
                    selectedBatchFiles.map(async (file) => ({
                        file_path: file.name,
                        content: await readFileContent(file)
                    }))
                );

                payload = {
                    files: fileContents.map(f => f.file_path),  // For workflow tracking
                    file_contents: fileContents,  // Array of {file_path, content}
                    family: document.getElementById('validationFamily').value,
                    validation_types: validationTypes,
                    max_workers: parseInt(document.getElementById('validationMaxWorkers').value),
                    upload_mode: true  // Flag to indicate client-side upload
                };
            } else {
                // Handle server-side file paths
                const filesText = document.getElementById('batchFilePaths').value;
                const files = filesText.split('\n').map(f => f.trim()).filter(f => f);

                if (files.length === 0) {
                    alert('Please enter at least one file path');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Start Validation';
                    return;
                }

                payload = {
                    files: files,
                    family: document.getElementById('validationFamily').value,
                    validation_types: validationTypes,
                    max_workers: parseInt(document.getElementById('validationMaxWorkers').value)
                };
            }
            runId = null;
        } else {
            alert('Please select a validation mode');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Start Validation';
            return;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            if (mode === 'single') {
                const validationId = result.id || result.validation_id;
                showValidationMessage(`Validation completed: ${result.status}`, 'success');
                
                activeValidationRuns.set(runId, {
                    validation_id: validationId,
                    mode: 'single',
                    status: result.status,
                    file_path: payload.file_path,
                    started_at: new Date().toISOString(),
                    completed: true
                });
                
                updateActiveValidationsDisplay();
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                const workflowId = result.workflow_id;
                showValidationMessage(`Batch validation started: ${workflowId}`, 'success');
                
                activeValidationRuns.set(workflowId, {
                    workflow_id: workflowId,
                    job_id: result.job_id,
                    mode: 'batch',
                    status: result.status,
                    files_total: result.files_total,
                    started_at: new Date().toISOString(),
                    completed: false
                });
                
                updateActiveValidationsDisplay();
                startValidationTracking(workflowId);
            }
            
            closeRunValidationModal();
        } else {
            showValidationMessage(`Failed to start validation: ${result.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error starting validation:', error);
        showValidationMessage(`Error: ${error.message}`, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Start Validation';
    }
});

function readFileContent(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('Failed to read file'));
        reader.readAsText(file);
    });
}

function updateActiveValidationsDisplay() {
    const section = document.getElementById('activeValidationsSection');
    const list = document.getElementById('activeValidationsList');
    
    if (activeValidationRuns.size === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    list.innerHTML = '';
    
    activeValidationRuns.forEach((run, runId) => {
        const runCard = document.createElement('div');
        runCard.className = 'validation-run-card';
        runCard.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 6px; background: #f9f9f9;';
        
        const statusBadge = `<span class="badge badge-${run.status}">${run.status}</span>`;
        const progressInfo = run.files_total 
            ? `<div style="font-size: 13px; color: #666; margin: 5px 0;">Files: ${run.files_total}</div>`
            : '';
        
        let actionButtons = '';
        if (run.mode === 'single' && run.validation_id) {
            actionButtons = `<a href="/dashboard/validations/${run.validation_id}" class="btn btn-primary btn-sm" style="text-decoration: none;">View</a>`;
        } else if (run.mode === 'batch' && run.workflow_id) {
            actionButtons = `<a href="/dashboard/workflows/${run.workflow_id}" class="btn btn-primary btn-sm" style="text-decoration: none;">View</a>`;
        }
        
        actionButtons += run.completed 
            ? ` <button class="btn btn-secondary btn-sm" onclick="removeValidationRun('${runId}')">Clear</button>`
            : ` <button class="btn btn-danger btn-sm" onclick="stopValidationTracking('${runId}')">Stop Tracking</button>`;
        
        runCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 5px;">
                        ${run.mode === 'single' ? 'Single Validation' : `Batch: ${runId.substring(0, 8)}...`}
                        ${statusBadge}
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        ${run.file_path || ''} | Started: ${new Date(run.started_at).toLocaleTimeString()}
                    </div>
                    ${progressInfo}
                </div>
                <div style="display: flex; gap: 5px;">
                    ${actionButtons}
                </div>
            </div>
        `;
        
        list.appendChild(runCard);
    });
}

function startValidationTracking(workflowId) {
    const intervalId = setInterval(async () => {
        try {
            const response = await fetch(`/workflows/${workflowId}`);
            const data = await response.json();
            
            const run = activeValidationRuns.get(workflowId);
            if (run) {
                run.status = data.state || data.status;
                run.progress_percent = data.progress_percent;
                
                if (data.state === 'completed' || data.state === 'failed' || data.state === 'cancelled') {
                    run.completed = true;
                    clearInterval(intervalId);
                    validationPollIntervals.delete(workflowId);
                    
                    if (data.state === 'completed') {
                        showValidationMessage('Batch validation completed', 'success');
                        setTimeout(() => location.reload(), 2000);
                    }
                }
                
                updateActiveValidationsDisplay();
            }
        } catch (error) {
            console.error(`Error polling workflow ${workflowId}:`, error);
        }
    }, 3000);
    
    validationPollIntervals.set(workflowId, intervalId);
}

function stopValidationTracking(runId) {
    if (validationPollIntervals.has(runId)) {
        clearInterval(validationPollIntervals.get(runId));
        validationPollIntervals.delete(runId);
    }
    activeValidationRuns.delete(runId);
    updateActiveValidationsDisplay();
}

function removeValidationRun(runId) {
    stopValidationTracking(runId);
}

function showValidationMessage(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alert.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 2000; min-width: 300px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);';
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}

let ws = null;
let liveRefreshEnabled = true;
let reconnectAttempts = 0;
let maxReconnectAttempts = 10;
let heartbeatInterval = null;

// Initialize WebSocket connection
function initWebSocket() {
    if (liveRefreshEnabled && (!ws || ws.readyState !== WebSocket.OPEN)) {
        ws = new WebSocket(`ws://${window.location.host}/ws/validation_updates`);
        
        ws.onopen = function() {
            console.log('WebSocket connected for live updates');
            showMessage('Live updates connected', 'success');
            reconnectAttempts = 0;
            
            // Start sending pings to keep connection alive
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
            heartbeatInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 25000);
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('Received update:', data);
            
            if (data.type === 'heartbeat') {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'pong' }));
                }
                return;
            }
            
            if (data.type === 'progress_update') {
                handleValidationUpdate(data.data);
            }
        };
        
        ws.onclose = function() {
            console.log('WebSocket disconnected');
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            if (liveRefreshEnabled && reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(initWebSocket, delay);
            } else if (reconnectAttempts >= maxReconnectAttempts) {
                showMessage('Live updates disconnected. Please refresh the page.', 'error');
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            showMessage('Live updates connection error', 'error');
        };
    }
}

function handleValidationUpdate(data) {
    const validationId = data.validation_id || (data.validation_ids && data.validation_ids[0]);
    
    if (validationId) {
        const row = document.querySelector(`tr[data-validation-id="${validationId}"]`);
        if (row) {
            const statusCell = row.querySelector('.badge');
            if (statusCell && data.type.includes('approved')) {
                statusCell.textContent = 'approved';
                statusCell.className = 'badge badge-approved';
            } else if (statusCell && data.type.includes('rejected')) {
                statusCell.textContent = 'rejected';
                statusCell.className = 'badge badge-rejected';
            } else if (statusCell && data.type.includes('enhanced')) {
                statusCell.textContent = 'enhanced';
                statusCell.className = 'badge badge-enhanced';
            }
            
            updateActionButtons(row, statusCell.textContent);
            showMessage(data.message || 'Validation updated', 'success');
        }
    }
}

function updateActionButtons(row, status) {
    const actionsCell = row.querySelector('td:last-child');
    if (!actionsCell) return;
    
    const validationId = row.getAttribute('data-validation-id');
    
    const buttons = actionsCell.querySelectorAll('button');
    buttons.forEach(btn => btn.remove());
    
    if (status === 'approved') {
        const enhanceBtn = document.createElement('button');
        enhanceBtn.className = 'btn btn-warning btn-sm';
        enhanceBtn.textContent = 'Enhance';
        enhanceBtn.onclick = () => singleAction('enhance', validationId);
        actionsCell.appendChild(enhanceBtn);
    } else if (status === 'pass' || status === 'fail' || status === 'warning') {
        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn btn-success btn-sm';
        approveBtn.textContent = 'Approve';
        approveBtn.onclick = () => singleAction('approve', validationId);
        actionsCell.appendChild(approveBtn);
        
        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn btn-danger btn-sm';
        rejectBtn.textContent = 'Reject';
        rejectBtn.onclick = () => singleAction('reject', validationId);
        actionsCell.appendChild(rejectBtn);
    }
}

async function singleAction(action, validationId) {
    try {
        let endpoint;
        if (action === 'enhance') {
            endpoint = `/api/enhance/${validationId}`;
        } else {
            endpoint = `/api/validations/${validationId}/${action}`;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message, 'success');
        } else {
            showMessage(`Failed to ${action}: ${result.errors?.join(', ') || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error(`Error ${action}ing validation:`, error);
        showMessage(`Error ${action}ing validation: ${error.message}`, 'error');
    }
}

async function bulkAction(action) {
    const selectedIds = Array.from(document.querySelectorAll('.validation-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showMessage('Please select validations to perform bulk action', 'warning');
        return;
    }
    
    try {
        let endpoint;
        if (action === 'enhance') {
            endpoint = '/api/validations/bulk/enhance';
        } else {
            endpoint = `/api/validations/bulk/${action}`;
        }
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ids: selectedIds })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage(result.message, 'success');
            document.querySelectorAll('.validation-checkbox:checked').forEach(cb => cb.checked = false);
            updateBulkActionButtons();
        } else {
            showMessage(`Bulk ${action} failed: ${result.errors?.join(', ') || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error(`Error in bulk ${action}:`, error);
        showMessage(`Error in bulk ${action}: ${error.message}`, 'error');
    }
}

function updateBulkActionButtons() {
    const selectedCount = document.querySelectorAll('.validation-checkbox:checked').length;
    const buttons = ['bulkApproveBtn', 'bulkRejectBtn', 'bulkEnhanceBtn'];
    
    buttons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        btn.disabled = selectedCount === 0;
    });
    
    document.getElementById('selectedCount').textContent = `${selectedCount} selected`;
}

function showMessage(message, type) {
    const messagesContainer = document.getElementById('statusMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert alert-${type}`;
    messageDiv.style.cssText = 'margin-bottom: 10px; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
    messageDiv.textContent = message;
    
    messagesContainer.appendChild(messageDiv);
    
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

async function generateRecommendations(validationId) {
    try {
        const response = await fetch(`/api/validations/${validationId}/recommendations/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showMessage(`Generated ${result.recommendations_generated || 0} recommendations for validation`, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            const error = await response.text();
            showMessage(`Failed to generate recommendations: ${error}`, 'error');
        }
    } catch (error) {
        showMessage(`Error: ${error.message}`, 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.validation-checkbox');
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkActionButtons();
    });
    
    document.querySelectorAll('.validation-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkActionButtons);
    });
    
    document.getElementById('liveRefresh').addEventListener('change', function() {
        liveRefreshEnabled = this.checked;
        if (liveRefreshEnabled) {
            initWebSocket();
        } else if (ws) {
            ws.close();
            ws = null;
        }
    });
    
    if (liveRefreshEnabled) {
        initWebSocket();
    }
    
    updateBulkActionButtons();
});
</script>

<style>
.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.alert {
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
}

.alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeaa7;
    color: #856404;
}

.alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.badge-approved {
    background-color: #28a745;
    color: white;
}

.badge-rejected {
    background-color: #dc3545;
    color: white;
}

.badge-enhanced {
    background-color: #17a2b8;
    color: white;
}

.form-control {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

textarea.form-control {
    resize: vertical;
    font-family: monospace;
}
</style>

{% endblock %}
