{% extends "base.html" %}

{% block title %}Validation Details - TBCV{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/dashboard/validations" class="btn btn-secondary">‚Üê Back to Validations</a>
</div>

<!-- Recommendations (shown first) -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2>Recommendations ({{ recommendations|length }})</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="rebuildRecommendations()">Rebuild</button>
            {% if recommendations %}
            <button class="btn btn-warning" onclick="enhanceSelected()">Enhance Selected</button>
            {% endif %}
        </div>
    </div>

    {% if recommendations %}
    <div style="margin-bottom: 15px;">
        <label>
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
            Select All
        </label>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" disabled>
                </th>
                <th>Title</th>
                <th>Type</th>
                <th>Status</th>
                <th>Target</th>
                <th>Confidence</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rec in recommendations %}
            <tr>
                <td>
                    <input type="checkbox" class="rec-checkbox" value="{{ rec.id }}"
                           {% if rec.status == 'accepted' or rec.status == 'approved' %}checked{% endif %}>
                </td>
                <td class="truncate" title="{{ rec.title }}">{{ rec.title }}</td>
                <td><span class="badge badge-secondary">{{ rec.type }}</span></td>
                <td><span class="badge badge-{{ rec.status }}">{{ rec.status }}</span></td>
                <td class="truncate" title="{{ rec.metadata.target.selector if rec.metadata and rec.metadata.target else 'N/A' }}">
                    {{ rec.metadata.target.selector if rec.metadata and rec.metadata.target else 'N/A' }}
                </td>
                <td>{{ "%.0f"|format(rec.confidence * 100) }}%</td>
                <td class="actions">
                    <a href="/dashboard/recommendations/{{ rec.id }}" class="btn btn-primary btn-sm">Review</a>
                    <button class="btn btn-secondary btn-sm" onclick="copyRecAsJSON('{{ rec.id }}')">Copy JSON</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>No recommendations for this validation</p>
        {% if validation.status != 'enhanced' %}
        <button class="btn btn-primary" onclick="generateRecommendations()">Generate Recommendations</button>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Validation Details (shown second) -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Validation Details</h2>

        <!-- Action Buttons -->
        <div id="actionButtons" style="display: flex; gap: 10px;">
            {% if validation.status not in ['approved', 'rejected', 'enhanced'] %}
            <button class="btn btn-success" onclick="performAction('approve')">
                Approve
            </button>
            <button class="btn btn-danger" onclick="performAction('reject')">
                Reject
            </button>
            {% endif %}
            {% if validation.status == 'approved' or validation.status == 'pass' %}
            <button
                class="btn btn-warning"
                onclick="performEnhancement()"
                id="enhanceBtn"
                {% if not validation.can_enhance %}disabled title="{{ validation.cannot_enhance_reason }}"{% endif %}>
                <span id="enhanceBtnText">üöÄ Enhance</span>
                <span id="enhanceBtnSpinner" style="display: none;">
                    <span class="spinner"></span> Enhancing...
                </span>
            </button>
            {% if not validation.can_enhance %}
            <span style="color: #856404; font-size: 14px; display: flex; align-items: center;">
                ‚ö†Ô∏è {{ validation.cannot_enhance_reason }}
            </span>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Progress Bar for Enhancement -->
    <div id="enhancementProgress" style="display: none; margin-bottom: 20px;">
        <div style="margin-bottom: 5px; display: flex; justify-content: space-between;">
            <span id="progressLabel">Processing...</span>
            <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
        </div>
    </div>

    <div class="detail-grid">
        <div class="detail-label">ID:</div>
        <div class="detail-value"><code>{{ validation.id }}</code></div>

        <div class="detail-label">File Path:</div>
        <div class="detail-value">{{ validation.file_path }}</div>

        <div class="detail-label">Status:</div>
        <div class="detail-value">
            <span id="statusBadge" class="badge badge-{{ validation.status }}">{{ validation.status }}</span>
        </div>

        <div class="detail-label">Severity:</div>
        <div class="detail-value">
            <span class="badge badge-{{ validation.severity }}">{{ validation.severity }}</span>
        </div>

        <div class="detail-label">Created:</div>
        <div class="detail-value">{{ validation.created_at }}</div>

        <div class="detail-label">Updated:</div>
        <div class="detail-value" id="updatedAt">{{ validation.updated_at }}</div>
    </div>

    {% if validation.notes %}
    <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 10px;">Notes</h3>
        <p id="validationNotes">{{ validation.notes }}</p>
    </div>
    {% endif %}

    <!-- Side-by-Side Diff Visualization -->
    {% if validation.status == 'enhanced' %}
    <div style="margin-top: 20px;" id="diffSection">
        <h3 style="margin-bottom: 10px;">Content Changes</h3>
        <div style="margin-bottom: 10px;">
            <button class="btn btn-secondary" onclick="toggleDiffView()">Toggle Diff View</button>
            <label style="margin-left: 15px;">
                <input type="radio" name="diffStyle" value="side-by-side" checked onchange="changeDiffStyle(this.value)"> Side-by-Side
            </label>
            <label style="margin-left: 10px;">
                <input type="radio" name="diffStyle" value="inline" onchange="changeDiffStyle(this.value)"> Inline
            </label>
        </div>
        <div id="diffViewer" style="display: none;">
            <div id="diffContainer" class="diff-container"></div>
        </div>
    </div>
    {% endif %}

    {% if validation.validation_results %}
    <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 10px;">Validation Results</h3>
        <pre>{{ validation.validation_results | tojson(indent=2) }}</pre>
    </div>
    {% endif %}
</div>

<!-- Toast Notifications Container -->
<div id="toastContainer" class="toast-container"></div>

<script>
const validationId = '{{ validation.id }}';
const filePath = {{ validation.file_path | tojson }};
let canEnhance = {{ 'true' if validation.can_enhance else 'false' }};
let cannotEnhanceReason = {{ validation.cannot_enhance_reason | default("") | tojson }};
let ws = null;
let currentDiffStyle = 'side-by-side';
let diffData = null;

// Toast notification system
function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type} toast-enter`;

    const icon = {
        'success': '‚úì',
        'error': '‚úó',
        'warning': '‚ö†',
        'info': '‚Ñπ'
    }[type] || '‚Ñπ';

    toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" onclick="closeToast(this)">&times;</button>
    `;

    container.appendChild(toast);

    // Trigger animation
    setTimeout(() => toast.classList.add('toast-show'), 10);

    // Auto-remove
    setTimeout(() => {
        closeToast(toast.querySelector('.toast-close'));
    }, duration);
}

function closeToast(btn) {
    const toast = btn.parentElement;
    toast.classList.remove('toast-show');
    toast.classList.add('toast-exit');
    setTimeout(() => toast.remove(), 300);
}

// Initialize WebSocket connection for live updates
function initWebSocket() {
    try {
        ws = new WebSocket(`ws://${window.location.host}/ws/validation_updates`);

        ws.onopen = function() {
            console.log('WebSocket connected for validation updates');
            showToast('Connected to live updates', 'success', 2000);
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('Received update:', data);

            if (data.type === 'progress_update') {
                handleValidationUpdate(data.data);
            } else if (data.type === 'enhancement_progress') {
                updateEnhancementProgress(data.data);
            }
        };

        ws.onclose = function() {
            console.log('WebSocket disconnected');
            setTimeout(initWebSocket, 5000);
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    } catch (error) {
        console.error('WebSocket init error:', error);
    }
}

// Handle validation updates from WebSocket
function handleValidationUpdate(data) {
    const updateValidationId = data.validation_id || (data.validation_ids && data.validation_ids[0]);

    if (updateValidationId === validationId) {
        const statusBadge = document.getElementById('statusBadge');

        if (data.type && data.type.includes('approved')) {
            statusBadge.textContent = 'approved';
            statusBadge.className = 'badge badge-approved';

            // Update enhancement availability when validation is approved
            canEnhance = true;
            cannotEnhanceReason = "";

            updateActionButtons('approved');
            showToast('Validation approved', 'success');
        } else if (data.type && data.type.includes('rejected')) {
            statusBadge.textContent = 'rejected';
            statusBadge.className = 'badge badge-rejected';

            // Disable enhancement when validation is rejected
            canEnhance = false;
            cannotEnhanceReason = "Validation must be approved before enhancement";

            updateActionButtons('rejected');
            showToast('Validation rejected', 'warning');
        } else if (data.type && data.type.includes('enhanced')) {
            statusBadge.textContent = 'enhanced';
            statusBadge.className = 'badge badge-enhanced';
            updateActionButtons('enhanced');
            showToast('Enhancement completed successfully!', 'success');

            // Reload page to show diff
            setTimeout(() => location.reload(), 2000);
        }

        document.getElementById('updatedAt').textContent = new Date().toISOString();
    }
}

// Update enhancement progress bar
function updateEnhancementProgress(data) {
    const progressBar = document.getElementById('enhancementProgress');
    const progressFill = document.getElementById('progressBarFill');
    const progressLabel = document.getElementById('progressLabel');
    const progressPercent = document.getElementById('progressPercent');

    progressBar.style.display = 'block';

    const percent = data.percent || 0;
    progressFill.style.width = `${percent}%`;
    progressPercent.textContent = `${percent}%`;
    progressLabel.textContent = data.message || 'Processing...';

    if (percent >= 100) {
        setTimeout(() => {
            progressBar.style.display = 'none';
        }, 2000);
    }
}

// Update action buttons based on status
function updateActionButtons(status) {
    const actionButtons = document.getElementById('actionButtons');
    actionButtons.innerHTML = '';

    if (status === 'approved' || status === 'pass') {
        const enhanceBtn = document.createElement('button');
        enhanceBtn.className = 'btn btn-warning';
        enhanceBtn.id = 'enhanceBtn';
        enhanceBtn.innerHTML = '<span id="enhanceBtnText">üöÄ Enhance</span>';
        enhanceBtn.onclick = performEnhancement;

        // Disable button if validation cannot be enhanced
        if (!canEnhance) {
            enhanceBtn.disabled = true;
            enhanceBtn.title = cannotEnhanceReason;
        }

        actionButtons.appendChild(enhanceBtn);

        // Add warning message if cannot enhance
        if (!canEnhance) {
            const warning = document.createElement('span');
            warning.style.cssText = 'color: #856404; font-size: 14px; display: flex; align-items: center;';
            warning.innerHTML = `‚ö†Ô∏è ${cannotEnhanceReason}`;
            actionButtons.appendChild(warning);
        }
    } else if (status === 'pass' || status === 'fail' || status === 'warning') {
        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn btn-success';
        approveBtn.textContent = 'Approve';
        approveBtn.onclick = () => performAction('approve');
        actionButtons.appendChild(approveBtn);

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn btn-danger';
        rejectBtn.textContent = 'Reject';
        rejectBtn.onclick = () => performAction('reject');
        actionButtons.appendChild(rejectBtn);
    }
}

// Perform action on validation
async function performAction(action) {
    try {
        const endpoint = `/api/validations/${validationId}/${action}`;

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        const result = await response.json();

        if (result.success || response.ok) {
            showToast(result.message || `Validation ${action}d successfully`, 'success');

            // Update UI immediately based on action
            const statusBadge = document.getElementById('statusBadge');
            if (action === 'approve') {
                statusBadge.textContent = 'approved';
                statusBadge.className = 'badge badge-approved';

                // Enable enhancement for approved validation
                canEnhance = true;
                cannotEnhanceReason = "";

                updateActionButtons('approved');
            } else if (action === 'reject') {
                statusBadge.textContent = 'rejected';
                statusBadge.className = 'badge badge-rejected';

                // Disable enhancement for rejected validation
                canEnhance = false;
                cannotEnhanceReason = "Validation must be approved before enhancement";

                updateActionButtons('rejected');
            }

            document.getElementById('updatedAt').textContent = new Date().toISOString();
        } else {
            showToast(`Failed to ${action}: ${result.errors?.join(', ') || result.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error(`Error ${action}ing validation:`, error);
        showToast(`Error ${action}ing validation: ${error.message}`, 'error');
    }
}

// Perform enhancement - FIXED VERSION
async function performEnhancement() {
    // Check if enhancement is allowed
    if (!canEnhance) {
        showToast(cannotEnhanceReason || 'Enhancement not available for this validation', 'error');
        return;
    }

    const enhanceBtn = document.getElementById('enhanceBtn');
    const enhanceBtnText = document.getElementById('enhanceBtnText');
    const enhanceBtnSpinner = document.getElementById('enhanceBtnSpinner');

    // Disable button and show spinner
    enhanceBtn.disabled = true;
    enhanceBtnText.style.display = 'none';
    if (enhanceBtnSpinner) enhanceBtnSpinner.style.display = 'inline';

    // Show progress bar
    updateEnhancementProgress({ percent: 10, message: 'Reading file content...' });

    try {
        // Step 1: Read file content
        const fileResponse = await fetch(`/api/files/read?path=${encodeURIComponent(filePath)}`);
        if (!fileResponse.ok) {
            throw new Error('Failed to read file content');
        }
        const fileData = await fileResponse.json();
        const content = fileData.content || '';

        updateEnhancementProgress({ percent: 20, message: 'Checking recommendations...' });

        // Step 2: Check if recommendations exist, generate if needed
        let recsResponse = await fetch(`/api/validations/${validationId}/recommendations`);
        if (!recsResponse.ok) {
            throw new Error('Failed to get recommendations');
        }
        let recsData = await recsResponse.json();

        // If no recommendations exist, generate them first
        if (!recsData.recommendations || recsData.count === 0) {
            updateEnhancementProgress({ percent: 25, message: 'Generating recommendations...' });

            const genResponse = await fetch(`/api/validations/${validationId}/recommendations/generate`, {
                method: 'POST'
            });

            if (!genResponse.ok) {
                throw new Error('Failed to generate recommendations');
            }

            // Re-fetch recommendations
            recsResponse = await fetch(`/api/validations/${validationId}/recommendations`);
            if (!recsResponse.ok) {
                throw new Error('Failed to get recommendations after generation');
            }
            recsData = await recsResponse.json();
        }

        updateEnhancementProgress({ percent: 35, message: 'Filtering recommendations...' });

        const recommendations = recsData.recommendations || [];
        const approvedRecs = recommendations.filter(r =>
            r.status === 'approved' || r.status === 'accepted' || r.status === 'pending' || r.status === 'proposed'
        );

        if (approvedRecs.length === 0) {
            throw new Error('No recommendations available. The content may already be perfect!');
        }

        updateEnhancementProgress({ percent: 50, message: `Applying ${approvedRecs.length} recommendations...` });

        // Step 3: Call enhancement endpoint
        const enhanceResponse = await fetch('/api/enhance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                validation_id: validationId,
                file_path: filePath,
                content: content,
                recommendations: approvedRecs.map(r => r.id),
                preview: false
            })
        });

        if (!enhanceResponse.ok) {
            const errorData = await enhanceResponse.json();
            throw new Error(errorData.detail || 'Enhancement failed');
        }

        const result = await enhanceResponse.json();

        updateEnhancementProgress({ percent: 90, message: 'Finalizing...' });

        if (result.success) {
            updateEnhancementProgress({ percent: 100, message: 'Enhancement complete!' });
            showToast(`Enhancement complete! Applied ${result.applied_count} recommendations`, 'success');

            // Update status
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = 'enhanced';
            statusBadge.className = 'badge badge-enhanced';

            // Reload page after 2 seconds to show diff
            setTimeout(() => location.reload(), 2000);
        } else {
            throw new Error(result.message || 'Enhancement failed');
        }

    } catch (error) {
        console.error('Error enhancing validation:', error);
        showToast(`Enhancement failed: ${error.message}`, 'error');
        updateEnhancementProgress({ percent: 0, message: 'Enhancement failed' });
        setTimeout(() => {
            document.getElementById('enhancementProgress').style.display = 'none';
        }, 3000);
    } finally {
        // Re-enable button
        enhanceBtn.disabled = false;
        enhanceBtnText.style.display = 'inline';
        if (enhanceBtnSpinner) enhanceBtnSpinner.style.display = 'none';
    }
}

// Toggle diff view visibility
function toggleDiffView() {
    const diffViewer = document.getElementById('diffViewer');
    const diffContainer = document.getElementById('diffContainer');

    if (diffViewer.style.display === 'none') {
        diffViewer.style.display = 'block';
        if (!diffData) {
            loadDiff();
        } else {
            renderDiff();
        }
    } else {
        diffViewer.style.display = 'none';
    }
}

// Change diff style
function changeDiffStyle(style) {
    currentDiffStyle = style;
    if (diffData) {
        renderDiff();
    }
}

// Load and display diff
async function loadDiff() {
    const diffContainer = document.getElementById('diffContainer');
    diffContainer.innerHTML = 'Loading diff...';

    try {
        const response = await fetch(`/api/validations/${validationId}/diff`);
        if (response.ok) {
            const data = await response.json();
            diffData = data;
            renderDiff();
        } else {
            diffContainer.innerHTML = '<p class="error-message">Failed to load diff</p>';
        }
    } catch (error) {
        console.error('Error loading diff:', error);
        diffContainer.innerHTML = `<p class="error-message">Error loading diff: ${error.message}</p>`;
    }
}

// Render diff based on current style
function renderDiff() {
    const diffContainer = document.getElementById('diffContainer');

    if (!diffData || !diffData.diff) {
        diffContainer.innerHTML = '<p>No diff data available</p>';
        return;
    }

    if (currentDiffStyle === 'side-by-side') {
        renderSideBySideDiff(diffData.diff);
    } else {
        renderInlineDiff(diffData.diff);
    }
}

// Render side-by-side diff
function renderSideBySideDiff(diff) {
    const diffContainer = document.getElementById('diffContainer');
    const lines = diff.split('\n');

    let originalLines = [];
    let enhancedLines = [];

    for (const line of lines) {
        if (line.startsWith('-') && !line.startsWith('---')) {
            originalLines.push({ type: 'removed', text: line.substring(1) });
            enhancedLines.push({ type: 'empty', text: '' });
        } else if (line.startsWith('+') && !line.startsWith('+++')) {
            originalLines.push({ type: 'empty', text: '' });
            enhancedLines.push({ type: 'added', text: line.substring(1) });
        } else if (!line.startsWith('@@') && !line.startsWith('---') && !line.startsWith('+++')) {
            originalLines.push({ type: 'unchanged', text: line });
            enhancedLines.push({ type: 'unchanged', text: line });
        }
    }

    let html = '<div class="diff-side-by-side">';
    html += '<div class="diff-pane diff-pane-original"><h4>Original</h4><pre>';

    for (const line of originalLines) {
        const cssClass = `diff-line-${line.type}`;
        html += `<div class="${cssClass}">${escapeHtml(line.text || ' ')}</div>`;
    }

    html += '</pre></div>';
    html += '<div class="diff-pane diff-pane-enhanced"><h4>Enhanced</h4><pre>';

    for (const line of enhancedLines) {
        const cssClass = `diff-line-${line.type}`;
        html += `<div class="${cssClass}">${escapeHtml(line.text || ' ')}</div>`;
    }

    html += '</pre></div></div>';
    diffContainer.innerHTML = html;
}

// Render inline diff
function renderInlineDiff(diff) {
    const diffContainer = document.getElementById('diffContainer');
    const lines = diff.split('\n');

    let html = '<pre class="diff-inline">';

    for (const line of lines) {
        if (line.startsWith('+') && !line.startsWith('+++')) {
            html += `<div class="diff-line-added">${escapeHtml(line)}</div>`;
        } else if (line.startsWith('-') && !line.startsWith('---')) {
            html += `<div class="diff-line-removed">${escapeHtml(line)}</div>`;
        } else if (!line.startsWith('@@') && !line.startsWith('---') && !line.startsWith('+++')) {
            html += `<div class="diff-line-unchanged">${escapeHtml(line)}</div>`;
        }
    }

    html += '</pre>';
    diffContainer.innerHTML = html;
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Toggle select all checkboxes
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.rec-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

// Rebuild recommendations
async function rebuildRecommendations() {
    if (!confirm('Rebuild all recommendations? This will delete existing ones and regenerate from validation results.')) {
        return;
    }

    showToast('Rebuilding recommendations...', 'info');

    try {
        const response = await fetch(`/api/validations/${validationId}/rebuild_recommendations`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (response.ok) {
            const result = await response.json();
            showToast(`Rebuilt ${result.count} recommendation(s)`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            const error = await response.json();
            showToast(`Failed to rebuild: ${error.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error rebuilding recommendations:', error);
        showToast(`Error: ${error.message}`, 'error');
    }
}

// Generate recommendations
async function generateRecommendations() {
    showToast('Generating recommendations...', 'info');

    try {
        const response = await fetch(`/api/validations/${validationId}/rebuild_recommendations`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        if (response.ok) {
            const result = await response.json();
            showToast(`Generated ${result.count} recommendation(s)`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            const error = await response.json();
            showToast(`Failed to generate: ${error.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error generating recommendations:', error);
        showToast(`Error: ${error.message}`, 'error');
    }
}

// Enhance selected recommendations
async function enhanceSelected() {
    const checkboxes = document.querySelectorAll('.rec-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);

    if (selectedIds.length === 0) {
        showToast('Please select at least one recommendation', 'warning');
        return;
    }

    if (!confirm(`Enhance with ${selectedIds.length} selected recommendation(s)?`)) {
        return;
    }

    showToast(`Processing ${selectedIds.length} recommendations...`, 'info');

    // Use the performEnhancement function with selected IDs
    performEnhancement();
}

// Copy recommendation as JSON
async function copyRecAsJSON(recId) {
    try {
        const response = await fetch(`/api/recommendations/${recId}`);
        if (response.ok) {
            const rec = await response.json();
            await navigator.clipboard.writeText(JSON.stringify(rec, null, 2));
            showToast('Copied to clipboard', 'success', 2000);
        }
    } catch (error) {
        console.error('Error copying recommendation:', error);
        showToast('Failed to copy', 'error');
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initWebSocket();
});
</script>

<style>
/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 400px;
}

.toast {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    background: white;
    border-left: 4px solid;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s ease;
}

.toast-enter {
    animation: slideIn 0.3s ease forwards;
}

.toast-show {
    opacity: 1;
    transform: translateX(0);
}

.toast-exit {
    animation: slideOut 0.3s ease forwards;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(400px); }
    to { opacity: 1; transform: translateX(0); }
}

@keyframes slideOut {
    from { opacity: 1; transform: translateX(0); }
    to { opacity: 0; transform: translateX(400px); }
}

.toast-success {
    border-left-color: #28a745;
    background: #d4edda;
}

.toast-error {
    border-left-color: #dc3545;
    background: #f8d7da;
}

.toast-warning {
    border-left-color: #ffc107;
    background: #fff3cd;
}

.toast-info {
    border-left-color: #17a2b8;
    background: #d1ecf1;
}

.toast-icon {
    font-size: 20px;
    font-weight: bold;
}

.toast-message {
    flex: 1;
    font-size: 14px;
}

.toast-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    opacity: 0.5;
    transition: opacity 0.2s;
}

.toast-close:hover {
    opacity: 1;
}

/* Progress Bar */
.progress-bar-container {
    width: 100%;
    height: 24px;
    background: #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #0056b3);
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: bold;
}

/* Spinner */
.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Diff Styles */
.diff-container {
    background: #f5f5f5;
    border-radius: 8px;
    overflow: hidden;
}

.diff-side-by-side {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: #ddd;
}

.diff-pane {
    background: white;
    overflow-x: auto;
}

.diff-pane h4 {
    margin: 0;
    padding: 10px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    font-size: 14px;
    font-weight: 600;
}

.diff-pane pre {
    margin: 0;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.5;
}

.diff-pane-original h4 {
    color: #721c24;
}

.diff-pane-enhanced h4 {
    color: #155724;
}

.diff-line-removed {
    background: #ffeef0;
    color: #b02a37;
    padding: 2px 4px;
}

.diff-line-added {
    background: #e6ffed;
    color: #22863a;
    padding: 2px 4px;
}

.diff-line-unchanged {
    padding: 2px 4px;
}

.diff-line-empty {
    background: #f8f9fa;
    padding: 2px 4px;
    min-height: 1.5em;
}

.diff-inline {
    margin: 0;
    padding: 10px;
    background: white;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.5;
}

/* Badge Styles */
.badge-approved {
    background-color: #28a745;
    color: white;
}

.badge-rejected {
    background-color: #dc3545;
    color: white;
}

.badge-enhanced {
    background-color: #17a2b8;
    color: white;
}

.detail-grid {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 10px;
    align-items: center;
}

.detail-label {
    font-weight: bold;
    color: #333;
}

.detail-value {
    padding: 5px;
}

.error-message {
    color: #dc3545;
    padding: 10px;
}
</style>

{% endblock %}
