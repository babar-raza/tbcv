{% extends "base.html" %}

{% block title %}Recommendations - TBCV{% endblock %}

{% block content %}
<h1 style="margin-bottom: 30px;">Recommendations</h1>

<!-- Filter Bar -->
<div class="filter-bar">
    <form method="GET" style="display: flex; gap: 15px; align-items: center; width: 100%;">
        <label for="status">Status:</label>
        <select name="status" id="status" onchange="this.form.submit()">
            <option value="">All</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
            <option value="accepted" {% if status_filter == 'accepted' %}selected{% endif %}>Accepted</option>
            <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
            <option value="applied" {% if status_filter == 'applied' %}selected{% endif %}>Applied</option>
        </select>
        
        <label for="type">Type:</label>
        <select name="type" id="type" onchange="this.form.submit()">
            <option value="">All Types</option>
            <option value="link_plugin" {% if type_filter == 'link_plugin' %}selected{% endif %}>Link Plugin</option>
            <option value="fix_format" {% if type_filter == 'fix_format' %}selected{% endif %}>Fix Format</option>
            <option value="add_info_text" {% if type_filter == 'add_info_text' %}selected{% endif %}>Add Info</option>
        </select>
        
        <button type="submit" class="btn btn-primary">Filter</button>
    </form>
</div>

<!-- Recommendations Table -->
<div class="card">
    {% if recommendations %}
    <!-- Bulk Actions Bar -->
    <div id="bulkActionsBar" style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 5px; display: none;">
        <span id="selectedCount">0 selected</span>
        <div style="display: inline-block; margin-left: 20px; gap: 10px;">
            <button class="btn btn-success btn-sm" onclick="bulkAction('accept')">Accept</button>
            <button class="btn btn-danger btn-sm" onclick="bulkAction('reject')">Reject</button>
            <button class="btn btn-warning btn-sm" onclick="bulkAction('enhance')">Enhance</button>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                </th>
                <th>Title</th>
                <th>Type</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Confidence</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for rec in recommendations %}
            <tr>
                <td>
                    <input type="checkbox" class="rec-checkbox" value="{{ rec.id }}" onchange="updateBulkActions()">
                </td>
                <td class="truncate" title="{{ rec.title }}">{{ rec.title }}</td>
                <td><span class="badge badge-secondary">{{ rec.type }}</span></td>
                <td><span class="badge badge-{{ rec.status }}">{{ rec.status }}</span></td>
                <td><span class="badge badge-warning">{{ rec.priority }}</span></td>
                <td>{{ "%.0f"|format(rec.confidence * 100) }}%</td>
                <td>{{ rec.created_at[:10] if rec.created_at else 'N/A' }}</td>
                <td class="actions">
                    <a href="/dashboard/recommendations/{{ rec.id }}" class="btn btn-primary btn-sm">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    {% if has_prev or has_next %}
    <div class="pagination">
        {% if has_prev %}
        <a href="?page={{ page - 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}" class="btn btn-secondary">← Previous</a>
        {% endif %}
        <span style="padding: 8px 16px;">Page {{ page }}</span>
        {% if has_next %}
        <a href="?page={{ page + 1 }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if type_filter %}&type={{ type_filter }}{% endif %}" class="btn btn-secondary">Next →</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <p>No recommendations found</p>
    </div>
    {% endif %}
</div>

<script>
function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.rec-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.rec-checkbox:checked');
    const count = checkboxes.length;
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    if (count > 0) {
        bulkBar.style.display = 'block';
        selectedCount.textContent = `${count} selected`;
    } else {
        bulkBar.style.display = 'none';
    }
}

async function bulkAction(action) {
    const checkboxes = document.querySelectorAll('.rec-checkbox:checked');
    const selectedIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Please select at least one recommendation');
        return;
    }
    
    const actionText = action === 'enhance' ? 'enhance with' : action;
    if (!confirm(`${actionText.charAt(0).toUpperCase() + actionText.slice(1)} ${selectedIds.length} recommendation(s)?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/recommendations/bulk_review', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ids: selectedIds,
                action: action
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`Successfully processed ${result.updated} recommendation(s)`);
            location.reload();
        } else {
            const error = await response.json();
            alert(`Failed: ${error.detail || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert(`Error: ${error.message}`);
    }
}
</script>

{% endblock %}
